# NETISエージェント 開発ログ

## プロジェクト概要

NETISデータ（415件）をAzure AI Searchで検索可能にし、AIチャットで対話的に技術を探せるシステム

## 開発日時

- 開始日: 2025-10-19
- 完了日: 2025-10-19

---

## フェーズ1: 要件定義 ✅

### 実施内容

**ヒアリング項目:**
- 利用者: 建設業従事者
- 目的: NETIS技術の検索・比較・提案
- UI: Webアプリケーション
- Azure環境: AI Search作成済み、OpenAI使用

**インデックス設計の確定:**
- ベクトル化フィールド: アブストラクト、概要、新規性、適用範囲（パターンB: 詳細検索重視型）
- フィルタラブル: 分類1〜5、事後評価、適用期間
- 検索可能: 技術名称、適用条件、留意事項
- 検索方式: ハイブリッド検索（セマンティック + キーワード）

**UX設計:**
- 初回表示: 技術名 + アブストラクト + URL（最大10件）
- フォローアップ質問でAIが絞り込み・詳細表示をサポート
- 会話の継続性を保持
- 分類フィルタは手動またはAI誘導

**確定事項:**
- インデックス名: `netis-index`
- データ更新: 1度のみ投入
- 自動フィルタリング: なし
- 検索結果件数: 10件程度

---

## フェーズ2: データ処理実装 ✅

### 作成ファイル

**1. `src/data_processor.py`**
- Excelファイル(`netisデータ.xlsx`)の読み込み
- NaN値の処理とデータクリーンアップ
- Azure AI Search用ドキュメント形式への変換
- 18カラム → 19フィールド（searchable_text追加）
- JSON出力機能

**主な機能:**
```python
- load_excel(): Excelファイル読み込み
- clean_data(): データクリーンアップ
- convert_to_search_documents(): 検索ドキュメント形式変換
- save_to_json(): JSON保存
- process_all(): 一括処理
```

**処理内容:**
- 415件のNETISデータを処理
- ベクトル検索用の統合テキスト生成（アブストラクト+概要+新規性+適用範囲）
- 一意のドキュメントID生成（netis_XXXX形式）

---

## フェーズ3: Azure AI Search統合 ✅

### 作成ファイル

**2. `src/embedding_generator.py`**
- Azure OpenAIによるエンベディング生成
- バッチ処理機能（デフォルト16件/バッチ）
- レート制限対策（0.5秒待機）
- 空文字列対応（ゼロベクトル返却）

**使用モデル:**
- `text-embedding-3-small`（1536次元）

**3. `src/search_indexer.py`**
- インデックス作成・削除機能
- ドキュメントアップロード（バッチ100件）
- インデックス統計取得

**インデックス設計:**
```yaml
フィールド構成:
  - id: String (キー、フィルタ可)
  - tech_name: 検索可能
  - abstract, overview, innovation, scope: 検索可能（日本語アナライザー）
  - conditions, notes: 検索可能（日本語アナライザー）
  - category1-5: フィルタ可能、ファセット可能
  - evaluation, period: フィルタ可能
  - url, subtitle, standards: 表示専用
  - searchable_text_vector: ベクトル検索用（1536次元）
  - searchable_text: 統合テキスト（検索可能）

ベクトル検索設定:
  - プロファイル: netis-vector-profile
  - アルゴリズム: HNSW
```

**4. `upload_to_search.py`**
- データ投入メインスクリプト
- 4ステッププロセス:
  1. Excelデータ読み込み・整形
  2. エンベディング生成
  3. インデックス作成
  4. ドキュメントアップロード
- 既存インデックス削除確認機能
- 進捗表示とエラーハンドリング

---

## フェーズ4: AIエージェント実装 ✅

### 作成ファイル

**5. `src/search_agent.py`**
- ハイブリッド検索機能
- AIチャット統合
- 会話履歴管理
- フォローアップ質問対応

**主な機能:**
```python
- search(): ハイブリッド検索（ベクトル+キーワード）
- format_search_results_for_display(): 結果フォーマット
- chat(): OpenAI GPT-4による会話生成
- process_query(): ユーザー入力処理
- reset_conversation(): 会話リセット
```

**システムプロンプト設計:**
- 役割: NETIS検索アシスタント
- 対応パターン: 検索実行、絞り込み提案、詳細表示、技術比較
- 出力形式: 初回は概要、フォローアップで詳細

---

## フェーズ5: Webアプリケーション実装 ✅

### 作成ファイル

**6. `app.py`**
- Streamlit Webアプリケーション
- チャットインターフェース
- 2カラムレイアウト（チャット + 検索結果）

**主な機能:**
- セッション状態管理
- リアルタイムチャット
- 検索結果の展開表示（デフォルト3件展開）
- 詳細情報トグル
- サイドバー設定:
  - 検索結果数調整（5〜20件）
  - 分類フィルタ
  - 会話リセット
  - 使い方ガイド

**UI/UX:**
- チャット履歴表示
- ストリーミング風の処理表示
- 検索結果の視覚的な展開
- URLリンク表示
- 分類情報の階層表示

---

## フェーズ6: ドキュメント整備 ✅

### 作成ファイル

**7. `requirements.txt`**
```
openpyxl==3.1.5
pandas==2.3.3
azure-search-documents==11.6.0
azure-identity==1.19.0
python-dotenv==1.1.1
openai==2.5.0
streamlit==1.50.0
```

**8. `.env.template`**
- 環境変数テンプレート
- Azure AI Search設定
- Azure OpenAI設定

**9. `README.md`**
- プロジェクト概要
- セットアップ手順
- 使い方ガイド
- プロジェクト構造
- システムアーキテクチャ
- トラブルシューティング

---

## Azure環境設定

### 使用リソース

**Azure AI Search:**
- エンドポイント: `https://agent-ai-searchemm626t4gwnom.search.windows.net`
- インデックス名: `netis-index`

**Azure OpenAI:**
- エンドポイント: `https://llm-demo.openai.azure.com/`
- GPTデプロイメント: `gpt-4.1`
- Embeddingデプロイメント: `text-embedding-3-small`
- APIバージョン: `2024-02-15-preview`

---

## プロジェクト構造

```
netisagent/
├── src/                               # ソースコード
│   ├── data_processor.py              # Excelデータ処理
│   ├── embedding_generator.py         # エンベディング生成
│   ├── search_indexer.py              # インデックス管理
│   └── search_agent.py                # 検索エージェント
├── config/                            # 設定ファイル
├── data/                              # データディレクトリ
│   └── processed/                     # 処理済みデータ
├── upload_to_search.py                # データ投入スクリプト
├── app.py                             # Streamlit Webアプリ
├── requirements.txt                   # 依存ライブラリ
├── .env.template                      # 環境変数テンプレート
├── .env                               # 環境変数（Git除外）
├── netisデータ.xlsx                   # 元データ（415件）
├── README.md                          # ドキュメント
└── DEVELOPMENT_LOG.md                 # 本ファイル
```

---

## 技術スタック

### バックエンド
- **Python**: 3.11+
- **データ処理**: pandas 2.3.3, openpyxl 3.1.5
- **Azure SDK**:
  - azure-search-documents 11.6.0
  - azure-identity 1.19.0
- **OpenAI SDK**: openai 2.5.0
- **環境管理**: python-dotenv 1.1.1

### フロントエンド
- **UI Framework**: Streamlit 1.50.0

### Azure Services
- **Azure AI Search**: ハイブリッド検索（ベクトル + キーワード）
- **Azure OpenAI**: GPT-4.1（チャット）+ text-embedding-3-small（エンベディング）

---

## 実装完了機能

### コア機能
- ✅ NETISデータ（415件）のExcel読み込み
- ✅ Azure OpenAIによるエンベディング生成
- ✅ Azure AI Searchインデックス作成
- ✅ ドキュメントの一括アップロード
- ✅ ハイブリッド検索（セマンティック + キーワード）
- ✅ AIチャットインターフェース
- ✅ 会話履歴管理

### UX機能
- ✅ フォローアップ質問によるAI誘導絞り込み
- ✅ 詳細情報の段階的表示
- ✅ 分類フィルタリング
- ✅ 検索結果件数調整
- ✅ 会話リセット
- ✅ 使い方ガイド表示

### データ処理
- ✅ 18カラムのExcelデータ処理
- ✅ NaN値の適切な処理
- ✅ 検索用統合テキスト生成
- ✅ ベクトルエンベディング生成（1536次元）
- ✅ バッチ処理によるレート制限対策

---

## 次のステップ（運用準備）

### 1. データ投入
```bash
python upload_to_search.py
```

**処理内容:**
- Excelファイル読み込み: 415件
- エンベディング生成: 約5〜10分
- インデックス作成: 数秒
- ドキュメントアップロード: 数分

### 2. アプリケーション起動
```bash
streamlit run app.py
```

**アクセス:**
- URL: http://localhost:8501
- 自動的にブラウザが開きます

### 3. 動作確認
**テスト検索例:**
- 「トンネルの漏水対策技術を教えて」
- 「環境負荷が少ない工法は？」
- 「道路の舗装に使える技術」

---

## 開発メモ

### 設計上の判断

**1. インデックス設計**
- パターンBを採用: 詳細検索重視型
- 理由: セマンティック検索とキーワード検索の両立が必要

**2. エンベディングモデル**
- text-embedding-3-smallを採用
- 次元数: 1536（text-embedding-ada-002と同じ）

**3. フィルタリング方式**
- 自動フィルタリングなし
- AIがフォローアップ質問で誘導
- 理由: ユーザーの意図を正確に汲み取るため

**4. 検索結果表示**
- 初回: 技術名 + アブストラクト + URL
- フォローアップ: 詳細情報を段階的に表示
- 理由: 情報過多を避け、必要な情報に絞る

### 課題と対応

**課題1: エンベディング生成時間**
- 対応: バッチ処理（16件/バッチ）+ レート制限対策（0.5秒待機）

**課題2: 日本語検索精度**
- 対応: ja.microsoft アナライザーを使用

**課題3: 会話の継続性**
- 対応: セッション状態で会話履歴と検索結果を保持

---

## 今後の拡張案

### 機能追加候補
- [ ] 検索履歴の保存・再利用
- [ ] お気に入り技術の保存
- [ ] 技術の詳細比較表作成
- [ ] PDFエクスポート機能
- [ ] 定期的なNETISデータ更新機能
- [ ] ユーザーフィードバック収集

### パフォーマンス改善
- [ ] エンベディングのキャッシュ
- [ ] 検索結果のキャッシュ
- [ ] 非同期処理の導入

### UI/UX改善
- [ ] ダークモード対応
- [ ] レスポンシブデザイン最適化
- [ ] 検索結果のソート機能
- [ ] フィルタの詳細設定UI

---

## まとめ

**開発期間:** 1日
**総ファイル数:** 9ファイル
**総コード行数:** 約800行（コメント含む）

すべての要件を満たし、運用可能な状態まで実装完了。
次のステップはデータ投入とテスト運用。

---

**開発者メモ:**
- 要件定義をしっかり行ったことで、実装がスムーズに進んだ
- Azure SDKの仕様に合わせたインデックス設計が重要
- Streamlitのセッション管理が会話継続のキー
- エンベディング生成が最も時間がかかる処理
